iptables - программа для работы с фаерволом netfilter

с сетевого интерфейса данные поступают в ядро и оттуда в фаервол
фаервол представляет из себя цепочку

       PREROUTING
        /       \
   INPUT       FORWARD
   OUTPUT        |
       \        /
       POSTROUTING

Каждая из которых состоит из таблиц:

raw - используется для настройки пакетов
mangle -изменение заголовков tos (байт qos) и ttl
nat - трансляция 
filter - фильтрация (основаная функция)
security - для настройки безопасности selinux

Настраиваются в основном таблицы nat filter
_____________
Каждая цепочка имеет стандартное правило DROP или ACCEPT
изменить -P INPUT ACCEPT 
узнать политику по умолчанию -nvL


-j - указывает действие
DROP - отбросить 
ACCEPT - немедленно пропустить
RETURN - передать на цепочку выше
CONTINUE - продолжить применение правил
REJECT

Состояния пакетов в userspace
--state
NEW - новый для пользователя
RELATED - связанное с другим соединением
ESTABLISHED - установленное соединение
INVALID - не может быть идентифицирован и не имеет статуса





Ключи
-F --flush - удалить все цепочки
-P --policy - изменить политику на цепочку
-R заменить правило
--line-numbers показать номера правил
--dport/--sport distination/source порт
--comment комментарий
! - инвертировать

MASQUERADE - применяется при динамическом подключении
SNAT - приминяется при статике
REDIRECT - перенаправление с одного порта на другой
REJECT- сбрасывает пакет и передает на хост сообщение

_____________________
Команды
Запретить icmp 
iptables -A INPUT -p icmp -j DROP
Просмотр цепочек вместe со статистикой 
-nVL
-L -t nat
Заблокировать порт 22
iptables -A INPUT -p tcp --dport ssh -j DROP
Заблокировать по ip
iptables -A INPUT -s 10.10.10.0/24 -j DROP
Сбросить счетчики
iptables -z INPUT 1
Удалить правило
iptables -D INPUT номер_строки
Перенаправить трафик с одного хоста на другой с изменением портов (при запросе
отображается адрес назначения, а не подменный)
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 80 -d 195.82.146.120/30 -j DNAT --to-destination 195.82.146.100:3128
Ограничить количество подключений с хоста
iptables -A FORWARD -s 172.16.0.0/12 -p tcp --syn -m connlimit --connlimit-above 200 -j DROP
Присвоить имя для пакетов
iptables -A FORWARD -i eth0 -m state --state NEW -m recent --set --name SYNF --rsource
Ограничим количество отправляемых пакетов во времени
iptables -A FORWARD -i eth0 -m state --state NEW -m recent --update --seconds 10 --hitcount 10 --rttl --name SYNF --rsource -j DROP



_____________________
Загрузка правил
Добавляем iptables в автозагрузку
файл настроек /etc/iptables/iptables.rules 
iptables-save > /etc/iptables/iptables.rules

xtables-addons - дополнения для обработки пакетов

___________________
nftables должен заменить iptables тк включает в себя функционал по работе с 
ip6tables aprtable
можно использовать доменное имя

____________________________
таблицы и цепочки

Таблицы nat filter mangle
Цепочки PREROUTING FORWARD INPUT OUTPUT

iptables -t filter -A FORWARD - пустая запись
-m --match - подключить модули

действия drop accept return 

Cтатусы подключения 
ASSURED - настройка tcp соединения завершена
EXPECTED - ожидание соединения
SEEN_REPLY - пакеты ходили в  двух направлениях

conntrack - connection tracking  - модуль отслеживания соединений

Добавить правила для отслеживания количества пакетов
SNAT - для статического соединения
MASQUERADE - для динамических настоек

-m mac - мак адрес
-psd -port scaning detector
__________________________________

модули ядра
conntrack - троссировка соединений
ftp - отдельный модуль по причине большой интенсивности
match limit - ограничение количества проверок
mark - маркировка пакетов
multiport - проверка диапазона портов
tos - работа с tos
mss - maximum segment size
match state - состояние пакета (новый, установленный)
unclean - дополнительная проверка на странности в пакетах
owner - доступ только пользователям
reject - отправка icmp сообщения об ошибке на хост
mirror - отправка пакета обратно
nat/masquerade - трансляция адресов
redirect - перенаправление
log
tcpmss - ограничение размера чтобы избежать ошибок

прохождение пакетов

filter forward - правила для обоих направлений

tos - устанавливаются биты qos. ttl. mark
nat
filter - применение политики фильтрации

conntrak 
cat /proc/net/ip_conntrak - выведет тросировку по соединению
флаги состояния соединения
sys  - syn/ack - established состояние соединения
fin - fin/ack - ack

2 минуты пакеты могут болтаться на фаерволе
related - позволяет рвать соединение

В области данных пакета может быть заключена информация о соединении ftp, icq

ftp открывает первое соединение - сеанс управления, а затем открывает
дополнительные порты

отслеживания состояния для nat требуют специализированных модулей
-t table - указание на таблицу (без принимается таблица filter)

-A - создать
-R - заменить
-D - удалить
-L - список правил для цепочки
-F - очистить
-Z - обнуление счетчиков
-N - создать новую цепочку
-X - удалить цепочку (без параметров удалит все цепочки кроме встроенных)
-P - задать политику
-E - переименование пользовательской цепочки

Общие критерии работы
-p --protocol - тип протокола /etc/protocols (0 - all)
-s --source источник пакета (диапазона)
-d --destination получатель пакета
-i --in-interface - входящий интерфейс (по умолчанию любой ,-i eth+)
-o --out-interface - исходящий 
-f --fragment - фрагменты разбитого пакета

tcp критерии
--sport - исходящий порт /etc/services 22:80 - задать диапазон
--dport 
--tcp-flags - маска и флаги пакета tcp (SYN, ACK, FIN, RST, URG, PSH)
--syn пакеты с флагом syn и сброшенным ack/fin (открытия tcp )
--tcp-option - пакет равный заданному числу

udp критерийй
--sport
--dport

icmp критерии
--icmp-type - тип сообщени icmp (iptables --protocol icmp --help)

Явные критерии
-m --match задать критерий т.к подгружать их нужно явно
-m limit - задаем лимиты и пишем информацию в лог - как некое ведро для
политики
--limit-burst - максимальное значение счетчика при котором срабатывает правило
--limit скорость откручивания счетчика назад
-m mac
--mac-source
-m mark
-m multiport правила для нескольких портов
--source-port - порты могут быть выбраны произвольно

--uid-owner  - проверка владельца
--gid-owner  - group id
--pid-owner - process id
--sid-owner - session id

-m state
iptables -A INPUT -m state --state RELATED,ESTABLISHED 

-m tos
-m ttl

Действия и переходы

новая цепочка должна быть в той же таблице
при проходе вложенной цепочки пакет идет в родительскую
в случае принятия пакета в дочерней цепочки - пакет принимается

--to-destination - адрес назначения  --to-destination 192.168.1.1-192.168.1.10
- диапазон

Проблемы в локальной и глобальной сети

DROP  просто сбрасывает пакеты REJECT - заставляет закрывать соединение

--log-level debug, info, notice, warning, warn, err, error, crit, alert, emerg и panic
iptables -A FORWARD -p tcp -j LOG --log-level debug
/var/log/iptables

Метка - метка не передается по сети
mirror и взлом собственного компьютера

QUEUE - ставит пакет в очередь (для проксирования и тп)
REDIRECT - перенаправить 
REJECT - icmp (default icmp-port-unrechable)
RETURN - возврат в родительскую цепочку


--to-source - подставить адрес исходящего пакета

