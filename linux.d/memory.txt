=== Основные термины:

Резидентная память - реально занятые страницы памяти
Виртуальная память - выделенные диапазоны адресного пространства
Свап - вытесненные на диск редко используемые страницы
Анонимная память - несвязанная ни с каким файлом на диске
PageFault - ловушка обращения к памяти
Адресное пространство (VMA)
PageTable - таблица транслирующая виртуальное адресное пространство в
физическое



=== Теория

LRU/2 - активные/неиспользуемые стариницы
Две очереди - активные и иннактивные очереди, если два раза запрошена
страница, то данные поднимаются в активную очередь. Если нет то страницы
вымывается.

Mmap vs O_Direct - как базы работают с памятью


=== Основные команды

egrep '(VmSize|VmRSS|VmSwap)' /proc/13355/status
VmRSS - реальная память
VmSize - виртуальная память
VmStack - под стэком
VmExe - под бинарником

Посмотреть адресное пространство под процессом:
pmap -k PID
cat /proc/PID/maps

Отключить oom-killer для процесса:
echo "-17"  > /proc/PID/oom_ad




=== Стратегии выделения памяти 
sudo sysctl -a | fgrep overcommit

Жесткая:
vm.overcommit_memory = 2 /жесткая политика выделения, не больше чем есть в
системе
vm.overcommit_ratio = 50 /не больше 50% от общего объема
Если нет памяти, то процессы не смогут получить памяти


Разрешать оптимистичное выделение памяти на любой запрос:
vm.overcommit_memory = 1 /
Если памяти не хватает, то приходит Omm-killer и убивает 9-сигналом самый
жирный процесс.
Приход omm-killer можно перевести в режим kernel-panic и рестартить систему

sysctl kernel.panic = 2 - через 2 секунды ребутать систему после omm-killer

vm.overcommit_memory = 0 /интелектуальное выделение


Каждый процесс работает в своей области виртуальных адресов. Tlb-кэш - часто
используемые страницы памяти - размер 4мб. Страница 4кб.
Если не удается разрешить то приходится обращаться к таблице трансляции.





=== Huge Pages

Использование HP - приложение должно поддерживать работу с ними, включить в
sysctl. Данные страницы не вытесняются в кэш.
Huge pages - до 2мб страницы
vm.nr_hugepages = 256 - резервируем hp в системе под запросы со стороны
приложений.
HugePages - часто используются вместе с базами данных


Посмотреть используются hp - cat /proc/meminfo
AnonHugePages - hp не трубующие поддержки со стороны приложения.
VmRSS - сколько адресного простаранства реально использует процесс
Threads - количество потоков

Опасный параметр, требуются нагрузочное тестирование с HP, особенно с
анонимным.


=== PageCache 

Все операции чтения и записи идут через PageCache
cached в free, /proc/meminfo

Данные пишутся в кэш, страницы помечаются как dirty. Узнать сколько памяти под
dirty /proc/meminfo | grep Dirty.



mincore - системный вызов проверки находится ли страница в Page Cache
vmtouch - утилита для работы с Paga Cache (дерьмовая)



