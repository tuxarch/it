Highload 2014
По мотивам лекций mail.ru
https://www.youtube.com/watch?v=uYhQ2ot3XFg&list=PLrCZzMib1e9qozAkJm0-IyBO2pkUdBLlM

##########################################
1. Введение

В чем измеряется нагрузка?
Количество запросов в секунду rps

SLA mail.ru 99.9 - 10 часов в год недоступен

Узкое место
В основном база данных

CGI - прикручиваем внешние программы к web-сервису. Много минусов.
Взаимодействуют через STDIN/STDOUT
FastCGI - работают через сокеты, не перезапускает скрипт, а запускает новый.

apache status - какие процессы исполняются
Php - кэширование запросов

Неблокирующая обработка (epoll системный вызов)


################################################
2. Сетевая подсистема

1Гб/с - 900-800мб/с реально
120 тыс пакетов в секунду
Можем упереться в количество пакетов, а не в скорость

Bonging - несколько физ. интерфейсов в логическое
4 соединения дают 3.5Гб/с

MSI-X 
Отдельные очереди для input/out пакетов
Считает контрольные суммы для http

Ставят 10GB - на сервера

cat /proc/interrupts - какие прерывания и кто их обрабатывает
Должно быть все равномерно, на процессах.

iperf - позволяет создать нагрузку между узлами (клиент-сервер)


2014
Трафик вконтакте - 1Тб/c трафика отдают
однокласники - 32Гб/с
все mail.ru - 200Гб/с
Мощность Ddos - 100GB/s < 1Tb/s(2018)

whois - кому принадлежит домен
traceroute - посмотреть маршрут

До японии и австралии за 270 мс

ttl - пакет умер, хост должен ответить об этом imcp
Опция частенько отключена


Посмотреть на путь из крупных провайдеров:
looking glass:

traceroute.net.ru
lookinglass.org
lg.vk.com
lg.megafon.ru

Один запрос одно действие - 4 запроса*50mc для построения страницы


Последний блок ipv4 адресов выдан в 2013 году


10.0.0.0
192.168.0.0 - сети отбрасываются внешними маршрутизаторами

TCP сессия 
SYN - флаг синхронизации, Номер байта с которого идут данные, sequence number
ACK - acknowledgment - подтвержденные данные

Длинна пакета 1,5 кб
jomboframe - можно использовать в локальной сети

Потеря пакетов в 1% может сломать всю систему. Дав нагрузку

Сервер держит от 50 до 100 тыс соединений.
Значение Keepalived определяет сколько соединение может висеть.

Применяйте TCP там где нужна надежность. 
UDP - может загрузить сеть, нужно регулировать скорость в случаее нагрузки.

Пиринг
Точка обмена трафиком между провайдерами 
MSK-IX - московская точка обмена трафиком.
Картельный сговор 5 крупных компаний
Перенаправляют трафик через Хелсенки из-за стоимости

Нет в России CDN, гоняем через москву
Vitio, Genix


Тюнинг TCP
/etc/sysctl.conf

Норм настройки
net.ip4tcp_max_syn_backlog = 32768 
net.ip4tcp_max_orphans = 131072
net.ip4tcp_max_tw_buckets = 180000 трэкинг соединений 

.
